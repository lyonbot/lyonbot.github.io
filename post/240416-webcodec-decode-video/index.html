<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no"><meta http-equiv="X-UA-Compatible" content="IE=edge"><!-- Icons / Favicon --><link rel="icon" href="/favicon.ico" sizes="any"><link rel="icon" href="/icon.svg" type="image/svg+xml"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="manifest" href="/manifest.webmanifest"><link rel="canonical" href="https://lyonbot.github.io/post/240416-webcodec-decode-video/"><!-- Primary Meta Tags --><title>使用 WebCodec 解码视频、抓帧截图、转GIF • yon&#39;s</title><meta name="title" content="使用 WebCodec 解码视频、抓帧截图、转GIF • yon's"><meta name="description" content="比ffmpeg.wasm速度快太多了。用来做视频转GIF的工具简直飞起。"><meta name="author" content="lyonbot"><!-- Theme Colour --><meta name="theme-color" content="#fafafa"><!-- Open Graph / Facebook --><meta property="og:type" content="article"><meta property="og:title" content="使用 WebCodec 解码视频、抓帧截图、转GIF"><meta property="og:description" content="比ffmpeg.wasm速度快太多了。用来做视频转GIF的工具简直飞起。"><meta property="og:url" content="https://lyonbot.github.io/post/240416-webcodec-decode-video/"><meta property="og:site_name" content="yon's"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://lyonbot.github.io/og-image/240416-webcodec-decode-video.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta property="article:author" content="lyonbot"><meta property="article:published_time" content="2024-04-16T00:00:00.000Z"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://lyonbot.github.io/post/240416-webcodec-decode-video/"><meta property="twitter:title" content="使用 WebCodec 解码视频、抓帧截图、转GIF"><meta property="twitter:description" content="比ffmpeg.wasm速度快太多了。用来做视频转GIF的工具简直飞起。"><meta property="twitter:image" content="https://lyonbot.github.io/og-image/240416-webcodec-decode-video.png"><!-- RSS auto-discovery --><link rel="alternate" type="application/rss+xml" title="yon's" href="/rss.xml"><script>(function(){const siteConfig = {"author":"lyonbot","title":"yon's","description":"I might express","lang":"zh-CN","ogLocale":"zh_CN","themeColorLight":"#fafafa","themeColorDark":"#1d1f21","date":{"locale":"zh-CN","options":{"day":"2-digit","month":"2-digit","year":"numeric"}}};

			const root = document.documentElement;
			const colorThemeMetaTag = document.querySelector("meta[name='theme-color']");

			// get user preference of dark mode, 1st local storage, 2nd browser
			function getThemePreference() {
				if (typeof localStorage !== "undefined" && localStorage.getItem("theme")) {
					return localStorage.getItem("theme");
				}
				return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
			}

			const isDark = getThemePreference() === "dark";

			// watch document element class attribute and update user preference when it changes.
			const observer = new MutationObserver(() => {
				const rootIsDark = root.classList.contains("dark");
				// set the meta attribute
				colorThemeMetaTag.setAttribute(
					"content",
					siteConfig[rootIsDark ? "themeColorDark" : "themeColorLight"]
				);
				// store user preference
				if (typeof localStorage !== "undefined") {
					localStorage.setItem("theme", rootIsDark ? "dark" : "light");
				}
			});
			observer.observe(root, { attributeFilter: ["class"] });

			// initailse root class attribute
			root.classList.toggle("dark", isDark);
		})();</script><link rel="stylesheet" href="/_astro/hoisted.0af36014.css" />
<link rel="stylesheet" href="/_astro/404.cc902ad1.css" />
<link rel="stylesheet" href="/_astro/_slug_.bb34e5f3.css" /><script type="module" src="/_astro/hoisted.1c0b157d.js"></script>
<script type="module" src="/_astro/page.756ffed2.js"></script></head><body><a href="#main" class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5">skip to content
</a><header id="main-header" class="group relative mb-28 flex items-center sm:ps-[4.5rem]"><div class="flex sm:flex-col"><a href="/" class="inline-flex items-center grayscale hover:filter-none sm:relative sm:inline-block"><svg class="me-3 h-10 w-6 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-20 sm:w-12" aria-hidden="true" focusable="false" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 272 480"><title>Logo</title><path d="M181.334 93.333v-40L226.667 80v40l-45.333-26.667ZM136.001 53.333 90.667 26.667v426.666L136.001 480V53.333Z" fill="#B04304"></path><path d="m136.001 119.944 45.333-26.667 45.333 26.667-45.333 26.667-45.333-26.667ZM90.667 26.667 136.001 0l45.333 26.667-45.333 26.666-45.334-26.666ZM181.334 53.277l45.333-26.666L272 53.277l-45.333 26.667-45.333-26.667ZM0 213.277l45.333-26.667 45.334 26.667-45.334 26.667L0 213.277ZM136 239.944l-45.333-26.667v53.333L136 239.944Z" fill="#FF5D01"></path><path d="m136 53.333 45.333-26.666v120L226.667 120V80L272 53.333V160l-90.667 53.333v240L136 480V306.667L45.334 360V240l45.333-26.667v53.334L136 240V53.333Z" fill="#53C68C"></path><path d="M45.334 240 0 213.334v120L45.334 360V240Z" fill="#B04304"></path></svg><span class="text-xl font-bold sm:text-2xl">yon&#39;s</span></a><nav id="navigation-menu" class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-[--theme-menu-bg] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none" aria-label="Main menu"><a href="/" class="px-4 py-4 sm:py-0 sm:hover:underline" rel="prefetch">Home</a><a href="/about/" class="px-4 py-4 sm:py-0 sm:hover:underline" rel="prefetch">About</a><a href="/post/" class="px-4 py-4 sm:py-0 sm:hover:underline" rel="prefetch">Blog</a></nav></div><theme-toggle class="ms-auto"><button type="button" id="toggle-theme" class="group relative h-9 w-9 rounded-md bg-zinc-200 p-2 ring-zinc-400 transition-all hover:ring-2 dark:bg-zinc-700" aria-label="Toggle Dark Mode"><svg id="sun-svg" class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all group-aria-pressed:scale-100 group-aria-pressed:opacity-100" aria-hidden="true" focusable="false" stroke-width="1.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path></svg><svg id="moon-svg" class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all group-aria-[pressed=false]:scale-100 group-aria-[pressed=false]:opacity-100" aria-hidden="true" focusable="false" stroke-width="1.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5"></circle><path d="M7.63262 3.06689C8.98567 3.35733 9.99999 4.56025 9.99999 6.00007C9.99999 7.65693 8.65685 9.00007 6.99999 9.00007C5.4512 9.00007 4.17653 7.82641 4.01685 6.31997" stroke="currentColor" stroke-width="1.5"></path><path d="M22 13.0505C21.3647 12.4022 20.4793 12 19.5 12C17.567 12 16 13.567 16 15.5C16 17.2632 17.3039 18.7219 19 18.9646" stroke="currentColor" stroke-width="1.5"></path><path d="M14.5 8.51L14.51 8.49889" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path><path d="M10 17C11.1046 17 12 16.1046 12 15C12 13.8954 11.1046 13 10 13C8.89543 13 8 13.8954 8 15C8 16.1046 8.89543 17 10 17Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path></svg></button></theme-toggle><button id="toggle-navigation-menu" class="group relative ms-8 h-7 w-7 sm:invisible sm:hidden" type="button" aria-label="Open main menu" aria-expanded="false" aria-haspopup="menu"><svg id="line-svg" class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0" aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9h16.5m-16.5 6.75h16.5"></path></svg><svg id="cross-svg" class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100" class="text-accent" aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg></button></header><main id="main" class="flex-1"><div class="gap-x-10 lg:flex lg:items-start"><aside class="sticky top-20 order-2 -me-32 hidden basis-64 lg:block"><div id="aside-container"></div><h2 class="font-semibold">Table of Contents</h2><ul class="mt-4 text-xs"><li class="line-clamp-2 hover:text-accent"><a class="block mt-2 text-xs" style="padding-left: 0ex" href="#使用-ffmpeg-生成高质量gif全是技巧和折磨" data-prose-heading-id="使用-ffmpeg-生成高质量gif全是技巧和折磨" aria-label="Scroll to section: 使用 ffmpeg 生成高质量GIF，全是技巧和折磨">使用 ffmpeg 生成高质量GIF，全是技巧和折磨</a></li><li class="line-clamp-2 hover:text-accent"><a class="block mt-2 text-xs" style="padding-left: 0ex" href="#做成在线工具" data-prose-heading-id="做成在线工具" aria-label="Scroll to section: 做成在线工具">做成在线工具</a></li><li class="line-clamp-2 hover:text-accent"><a class="block mt-2 text-xs" style="padding-left: 0ex" href="#使用-webcodec-解码视频抓帧" data-prose-heading-id="使用-webcodec-解码视频抓帧" aria-label="Scroll to section: 使用 WebCodec 解码视频、抓帧">使用 WebCodec 解码视频、抓帧</a></li><li class="line-clamp-2 hover:text-accent"><a class="block mt-2 text-xs" style="padding-left: 2ex" href="#使用-mp4boxjs-加载文件" data-prose-heading-id="使用-mp4boxjs-加载文件" aria-label="Scroll to section: 使用 mp4box.js 加载文件">使用 mp4box.js 加载文件</a></li><li class="line-clamp-2 hover:text-accent"><a class="block mt-2 text-xs" style="padding-left: 2ex" href="#初始化解码器" data-prose-heading-id="初始化解码器" aria-label="Scroll to section: 初始化解码器">初始化解码器</a></li><li class="line-clamp-2 hover:text-accent"><a class="block mt-2 text-xs" style="padding-left: 2ex" href="#抽取视频流解码画面" data-prose-heading-id="抽取视频流解码画面" aria-label="Scroll to section: 抽取视频流，解码画面">抽取视频流，解码画面</a></li><li class="line-clamp-2 hover:text-accent"><a class="block mt-2 text-xs" style="padding-left: 2ex" href="#跳过前后只解码一个时间范围" data-prose-heading-id="跳过前后只解码一个时间范围" aria-label="Scroll to section: 跳过前后，只解码一个时间范围">跳过前后，只解码一个时间范围</a></li><li class="line-clamp-2 hover:text-accent"><a class="block mt-2 text-xs" style="padding-left: 2ex" href="#解决手机录像画面颠倒的问题" data-prose-heading-id="解决手机录像画面颠倒的问题" aria-label="Scroll to section: 解决手机录像，画面颠倒的问题">解决手机录像，画面颠倒的问题</a></li><li class="line-clamp-2 hover:text-accent"><a class="block mt-2 text-xs" style="padding-left: 0ex" href="#最后" data-prose-heading-id="最后" aria-label="Scroll to section: 最后">最后</a></li><li class="line-clamp-2 hover:text-accent"><a class="block mt-2 text-xs" style="padding-left: 2ex" href="#最最后碎碎念一段-signal" data-prose-heading-id="最最后碎碎念一段-signal" aria-label="Scroll to section: 最最后，碎碎念一段 Signal">最最后，碎碎念一段 Signal</a></li></ul></aside><article class="flex-grow break-words"><div id="blog-hero"><h1 class="title mb-3 sm:mb-1">使用 WebCodec 解码视频、抓帧截图、转GIF</h1><time datetime="2024-04-16T00:00:00.000Z">2024/04/16</time><div class="mt-1 sm:mt-0 sm:inline sm:before:mx-2 sm:before:content-['|']"><svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" class="mr-1 inline-block h-6 w-6" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M7.859 6h-2.834a2.025 2.025 0 0 0 -2.025 2.025v2.834c0 .537 .213 1.052 .593 1.432l6.116 6.116a2.025 2.025 0 0 0 2.864 0l2.834 -2.834a2.025 2.025 0 0 0 0 -2.864l-6.117 -6.116a2.025 2.025 0 0 0 -1.431 -.593z"></path><path d="M17.573 18.407l2.834 -2.834a2.025 2.025 0 0 0 0 -2.864l-7.117 -7.116"></path><path d="M6 9h-.01"></path></svg><a class="cactus-link inline-block before:content-['#']" aria-label="View more blogs with the tag 多媒体" href="/tags/多媒体/">多媒体</a>, <a class="cactus-link inline-block before:content-['#']" aria-label="View more blogs with the tag 前端技术" href="/tags/前端技术/">前端技术</a></div><p class="mt-8">比ffmpeg.wasm速度快太多了。用来做视频转GIF的工具简直飞起。</p></div><div class="prose prose-cactus mt-12 headings:font-semibold prose-th:before:content-none"><blockquote>
<p>在浏览器内将视频转GIF，无需上传，速度飞快</p>
<p>✨ 已上线 <a href="https://lyonbot.github.io/video-to-gif/">https://lyonbot.github.io/video-to-gif/</a></p>
</blockquote>
<h2 id="使用-ffmpeg-生成高质量gif全是技巧和折磨">使用 ffmpeg 生成高质量GIF，全是技巧和折磨</h2>
<p>上周五写一个材料的时候，需要插入几个 GIF 演示动图。一开始我熟练的打开终端，使用了我这段祖传 ffmpeg 生成高质量 GIF 的命令：</p>
<pre class="astro-code dracula" style="background-color:#282A36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#50FA7B">ffmpeg</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">-i</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">scr1.mov</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">-vf</span><span style="color:#F8F8F2"> </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">fps=10,scale=320:-1:flags=lanczos,split[s0][s1];[s0]palettegen=max_colors=255[p];[s1][p]paletteuse</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">-loop</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">output.gif</span></span></code></pre>
<p>但是转换过程不太顺利，因为输出的 GIF 文件太大了，我不得不去精细地调整参数，把各种骚操作都尝试一遍，包括但不限于：</p>
<ul>
<li>剪辑视频：在 <code>-i</code> 前插入想要的时间范围 <code>-ss 00:00:00 -to 00:00:05</code></li>
<li>调整分辨率：<code>scale=320:-1</code> 表示宽度 320，高度自动</li>
<li>加速视频：<code>setpts=PTS/2</code> 两倍速</li>
<li>调整颜色数量：酌情降低 <code>max_colors=255</code></li>
<li>去掉 GIF Dither：屏幕录像一般不需要颜色抖动，可以在 <code>paletteuse</code> 后面加参数 <code>dither=none</code></li>
<li>分两步骤生成：先对原视频剪辑、加速、缩放，生成临时的视频文件后，再走 GIF 转换逻辑。这样 ffmpeg 会快很多。</li>
<li>and more</li>
</ul>
<p>技巧很多，但是操作起来要来回在终端、文件管理器之间切换。虽然看起来很 Geek，但是真的浪费时间。</p>
<h2 id="做成在线工具">做成在线工具</h2>
<p>其实很早之前就想把 ffmpeg 的指令生成过程，做成在线工具，并且可以在浏览器运行。一方面，可视化配置参数很舒服；一方面省了安装 ffmpeg 和复制路径的麻烦事。</p>
<p>但是对生成 GIF 这件事而言，知道那么多魔法咒语，好像没啥用，还显得非常 nerd。</p>
<p>所以上周五，我决定单独把 <strong>视频转GIF</strong> 这件事情，直接做到网页中，并且将那些精细的调整功能、观察文件大小的功能，都。</p>
<p>于是就有了这个 <a href="https://lyonbot.github.io/video-to-gif/">🔨 video-to-gif 的小工具</a></p>

<video src="/_astro/video-to-gif.84391a6c.mp4" loop="-1" muted="true" autoplay class="max-w-full mx-auto block"></video>
<p>但是方案落地也走了挺多弯路。</p>
<p>GIF 的生成包括解码原视频、生成色板、编码为GIF三部分。</p>
<p>一开始是直接让 <a href="https://ffmpegwasm.netlify.app/">ffmpeg.wasm</a> 一步到位解码视频+编码 GIF ，奈何 wasm 解码速度太差。后来改成 video 抓画面，再到改成 WebCodec 超高速解码。然而解码也分很多步骤：解析 mp4 文件、配置解码器、抽取要解码的数据块、进行解码、根据坐标变换修正图片。</p>
<p>而 GIF 编码这部分，虽然 ffmpeg.wasm 已经很快，但是其加载出错的时候还得有 JS 兜底方案。一开始用的 <a href="https://github.com/jnordberg/gif.js">gif.js</a> ，因为其未暴露颜色数量控制能力，改成了 <a href="https://github.com/qq15725/modern-gif">modern-gif</a></p>
<h2 id="使用-webcodec-解码视频抓帧">使用 WebCodec 解码视频、抓帧</h2>
<p>WebCodec 是一个很新的浏览器 API（Chrome &gt;94，2021年9月的版本；Safari 16.4，2023年3月版本）。
它允许开发者直接解码视频帧，而不需要依赖任何外部库。并且还能得到系统级的加速，减少对浏览器内存的占用。</p>
<p>但是使用这个东西，并不是直接把 mp4 文件丢进去就可以了。完整的过程包括：解析 mp4 文件、配置解码器、抽取要解码的数据块、进行解码、根据坐标变换修正图片。</p>
<p>实现的过程我参考了这些项目：</p>
<ul>
<li><a href="https://github.com/w3c/webcodecs/tree/main/samples">https://github.com/w3c/webcodecs/tree/main/samples</a></li>
<li><a href="https://github.com/vjeux/mp4-h264-re-encode">https://github.com/vjeux/mp4-h264-re-encode</a></li>
</ul>
<p>并且还有使用 <a href="https://gpac.github.io/mp4box.js/test/filereader.html">mp4box.js 的 FileReader 工具</a> 来分析文件。</p>
<h3 id="使用-mp4boxjs-加载文件">使用 mp4box.js 加载文件</h3>
<p>视频文件 mp4/mov 只是一个“容器”，它存储了视频、音轨、文件描述等信息。我们首先需要的是将里面的“解码器参数”和“视频数据”抽取出来。</p>
<p>安装 <a href="https://github.com/gpac/mp4box.js">mp4box.js</a> 库： <code>pnpm install mp4box</code></p>
<p>然后使用下面代码，可以解析文件</p>
<pre class="astro-code dracula" style="background-color:#282A36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#FF79C6">import</span><span style="color:#F8F8F2"> MP4Box </span><span style="color:#FF79C6">from</span><span style="color:#F8F8F2"> </span><span style="color:#E9F284">&#39;</span><span style="color:#F1FA8C">mp4box</span><span style="color:#E9F284">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">// 此处 file 是一个 Blob 对象</span></span>
<span class="line"><span style="color:#FF79C6">async</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">function</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">decodeMp4File</span><span style="color:#F8F8F2">(</span><span style="color:#FFB86C;font-style:italic">file</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#F8F8F2">  </span><span style="color:#FF79C6">const</span><span style="color:#F8F8F2"> mp4boxInputFile </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> MP4Box.</span><span style="color:#50FA7B">createFile</span><span style="color:#F8F8F2">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">  </span><span style="color:#6272A4">// 方便后面用 await 等待</span></span>
<span class="line"><span style="color:#F8F8F2">  </span><span style="color:#FF79C6">const</span><span style="color:#F8F8F2"> mp4InfoPromise </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6;font-weight:bold">new</span><span style="color:#F8F8F2"> </span><span style="color:#8BE9FD;font-style:italic">Promise</span><span style="color:#F8F8F2">((</span><span style="color:#FFB86C;font-style:italic">resolve</span><span style="color:#F8F8F2">, </span><span style="color:#FFB86C;font-style:italic">reject</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">=&gt;</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#F8F8F2">    mp4boxInputFile.onReady </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> resolve</span></span>
<span class="line"><span style="color:#F8F8F2">    mp4boxInputFile.onError </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> reject</span></span>
<span class="line"><span style="color:#F8F8F2">  })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">  </span><span style="color:#6272A4">// 读取文件并解析</span></span>
<span class="line"><span style="color:#F8F8F2">  </span><span style="color:#FF79C6">const</span><span style="color:#F8F8F2"> buffer </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">await</span><span style="color:#F8F8F2"> file.</span><span style="color:#50FA7B">arrayBuffer</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#F8F8F2">  buffer.fileStart </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">  </span><span style="color:#6272A4">// 这个很重要，mp4box.js 需要知道每一个 Buffer 相对原始文件的位置（因为它可以跳着解析 mp4）</span></span>
<span class="line"><span style="color:#F8F8F2">  mp4boxInputFile.</span><span style="color:#50FA7B">appendBuffer</span><span style="color:#F8F8F2">(buffer)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">  </span><span style="color:#6272A4">// 等待 mp4box 获取文件信息</span></span>
<span class="line"><span style="color:#F8F8F2">  </span><span style="color:#FF79C6">const</span><span style="color:#F8F8F2"> info </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">await</span><span style="color:#F8F8F2"> mp4InfoPromise;</span></span>
<span class="line"><span style="color:#F8F8F2">  </span><span style="color:#FF79C6">const</span><span style="color:#F8F8F2"> track </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> info.videoTracks[</span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">];</span></span>
<span class="line"><span style="color:#F8F8F2">  </span><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> description; </span><span style="color:#6272A4">// 视频解码器的配置参数，是 Uint8Array</span></span>
<span class="line"><span style="color:#F8F8F2">  {</span></span>
<span class="line"><span style="color:#F8F8F2">    </span><span style="color:#FF79C6">const</span><span style="color:#F8F8F2"> DataStream </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> MP4Box.DataStream; </span><span style="color:#6272A4">// mp4box.js 内置了一个魔改版的 DataStream 包</span></span>
<span class="line"><span style="color:#F8F8F2">    </span><span style="color:#FF79C6">const</span><span style="color:#F8F8F2"> trak </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> mp4boxInputFile.</span><span style="color:#50FA7B">getTrackById</span><span style="color:#F8F8F2">(track.id);</span></span>
<span class="line"><span style="color:#F8F8F2">    </span><span style="color:#FF79C6">for</span><span style="color:#F8F8F2"> (</span><span style="color:#FF79C6">const</span><span style="color:#F8F8F2"> entry </span><span style="color:#FF79C6">of</span><span style="color:#F8F8F2"> trak.mdia.minf.stbl.stsd.entries) {    </span><span style="color:#6272A4">// 跟着 MPEG 标准走就对了，信息是藏在这个 mp4 box（数据盒子）里</span></span>
<span class="line"><span style="color:#F8F8F2">      </span><span style="color:#FF79C6">if</span><span style="color:#F8F8F2"> (entry.avcC </span><span style="color:#FF79C6">||</span><span style="color:#F8F8F2"> entry.hvcC) {  </span><span style="color:#6272A4">// hvc 是 H.265 格式的文件； avc 是 H.264 的</span></span>
<span class="line"><span style="color:#F8F8F2">        </span><span style="color:#FF79C6">const</span><span style="color:#F8F8F2"> stream </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6;font-weight:bold">new</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">DataStream</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">undefined</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">, DataStream.</span><span style="color:#BD93F9">BIG_ENDIAN</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#F8F8F2">        </span><span style="color:#FF79C6">if</span><span style="color:#F8F8F2"> (entry.avcC) entry.avcC.</span><span style="color:#50FA7B">write</span><span style="color:#F8F8F2">(stream);</span></span>
<span class="line"><span style="color:#F8F8F2">        </span><span style="color:#FF79C6">else</span><span style="color:#F8F8F2"> entry.hvcC.</span><span style="color:#50FA7B">write</span><span style="color:#F8F8F2">(stream);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">        description </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6;font-weight:bold">new</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">Uint8Array</span><span style="color:#F8F8F2">(stream.buffer, </span><span style="color:#BD93F9">8</span><span style="color:#F8F8F2">); </span><span style="color:#6272A4">// 去掉前8字节，也就是 mp4 的 box 的头</span></span>
<span class="line"><span style="color:#F8F8F2">        </span><span style="color:#FF79C6">break</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#F8F8F2">      }</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">    </span><span style="color:#FF79C6">if</span><span style="color:#F8F8F2"> (</span><span style="color:#FF79C6">!</span><span style="color:#F8F8F2">description) </span><span style="color:#FF79C6">throw</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6;font-weight:bold">new</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">Error</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">&#39;</span><span style="color:#F1FA8C">no video description</span><span style="color:#E9F284">&#39;</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<h3 id="初始化解码器">初始化解码器</h3>
<p>以上我们得到了这个 MP4 文件的编码参数，接下来就可以请出 <a href="https://developer.mozilla.org/en-US/docs/Web/API/VideoDecoder">VideoDecoder</a> 解码器来获取画面了。</p>
<p>和视频回放不同，解码器会以最快的速度，将画面帧 <a href="https://developer.mozilla.org/en-US/docs/Web/API/VideoFrame">VideoFrame 对象</a> 一个个的取出来给你。你要做的就是在一个回调函数里处理它，并且得及时 <code>.close()</code> 释放画面帧的资源。</p>
<p>初始化解码器，需要这些信息：</p>
<ul>
<li><code>output</code> 回调函数，告知如何处理解码得到的画面</li>
<li><code>error</code> 出错时候的回调函数</li>
<li>从 mp4 里解析得到的解码器信息（尤其那个 <code>description</code> 很重要）</li>
</ul>
<pre class="astro-code dracula" style="background-color:#282A36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#FF79C6">const</span><span style="color:#F8F8F2"> decoder </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6;font-weight:bold">new</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">VideoDecoder</span><span style="color:#F8F8F2">({</span></span>
<span class="line"><span style="color:#F8F8F2">  </span><span style="color:#50FA7B">output</span><span style="color:#F8F8F2">(</span><span style="color:#FFB86C;font-style:italic">inputFrame</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#F8F8F2">    </span><span style="color:#6272A4">// 此处就是回调函数，需要及时处理 VideoFrame 对象</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">    </span><span style="color:#6272A4">// 你还可以知道这一帧的时间戳、持续时间</span></span>
<span class="line"><span style="color:#F8F8F2">    </span><span style="color:#FF79C6">const</span><span style="color:#F8F8F2"> timestamp </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> inputFrame.timestamp </span><span style="color:#FF79C6">/</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">1e6</span><span style="color:#F8F8F2">  </span><span style="color:#6272A4">// 单位是微秒，我们换算成秒</span></span>
<span class="line"><span style="color:#F8F8F2">    </span><span style="color:#FF79C6">const</span><span style="color:#F8F8F2"> duration </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> inputFrame.duration </span><span style="color:#FF79C6">/</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">1e6</span><span style="color:#F8F8F2">  </span><span style="color:#6272A4">// 单位是微秒，我们换算成秒</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">    </span><span style="color:#6272A4">// 比如我会准备一个临时的 canvas，将画面绘制下来，然后释放画面帧的资源</span></span>
<span class="line"><span style="color:#F8F8F2">    </span><span style="color:#6272A4">// 备注： VideoFrame 是可以安全传送给 Worker 处理的，这部分逻辑其实可以挪到 WebWorker 里</span></span>
<span class="line"><span style="color:#F8F8F2">    ctx.</span><span style="color:#50FA7B">clearRect</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">, canvas.width, canvas.height)</span></span>
<span class="line"><span style="color:#F8F8F2">    ctx.</span><span style="color:#50FA7B">drawImage</span><span style="color:#F8F8F2">(inputFrame, </span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">    </span><span style="color:#FF79C6">const</span><span style="color:#F8F8F2"> data </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> ctx.</span><span style="color:#50FA7B">getImageData</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">, canvas.width, canvas.height)</span></span>
<span class="line"><span style="color:#F8F8F2">    </span><span style="color:#6272A4">// TODO: 处理 data</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">    </span><span style="color:#6272A4">// 画面帧使用完记得释放资源！（如果是 Worker 里处理，则在 worker 调用）</span></span>
<span class="line"><span style="color:#F8F8F2">    inputFrame.</span><span style="color:#50FA7B">close</span><span style="color:#F8F8F2">();</span></span>
<span class="line"><span style="color:#F8F8F2">  },</span></span>
<span class="line"><span style="color:#F8F8F2">  </span><span style="color:#50FA7B">error</span><span style="color:#F8F8F2">(</span><span style="color:#FFB86C;font-style:italic">error</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#F8F8F2">    </span><span style="color:#6272A4">// 处理错误情况</span></span>
<span class="line"><span style="color:#F8F8F2">  },</span></span>
<span class="line"><span style="color:#F8F8F2">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">// 使用前面解析的信息，初始化解码器</span></span>
<span class="line"><span style="color:#F8F8F2">decoder.</span><span style="color:#50FA7B">configure</span><span style="color:#F8F8F2">({</span></span>
<span class="line"><span style="color:#F8F8F2">  codec</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> track.codec,</span></span>
<span class="line"><span style="color:#F8F8F2">  codedWidth</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> track.track_width,</span></span>
<span class="line"><span style="color:#F8F8F2">  codedHeight</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> track.track_height,</span></span>
<span class="line"><span style="color:#F8F8F2">  description,</span></span>
<span class="line"><span style="color:#F8F8F2">  hardwareAcceleration</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> </span><span style="color:#E9F284">&#39;</span><span style="color:#F1FA8C">prefer-hardware</span><span style="color:#E9F284">&#39;</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">});</span></span></code></pre>
<h3 id="抽取视频流解码画面">抽取视频流，解码画面</h3>
<p>视频画面数据，是由一大串的数据包构成的。具体的拆包方式、码流格式等标准很复杂，要去理解就太麻烦了。
幸运的是， mp4box.js 已经提供了实用的方法，帮你找出那些数据包，你要做的就是，将数据包转发给 decoder 去解码画面。</p>
<p>我们只需要配置一个回调函数，然后让 mp4box 开始监测视频轨道的数据，一旦解析到数据包就触发回调，去解码画面。</p>
<pre class="astro-code dracula" style="background-color:#282A36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#F8F8F2">mp4boxInputFile.</span><span style="color:#50FA7B">onSamples</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> (</span><span style="color:#FFB86C;font-style:italic">track_id</span><span style="color:#F8F8F2">, </span><span style="color:#FFB86C;font-style:italic">unused</span><span style="color:#F8F8F2">, </span><span style="color:#FFB86C;font-style:italic">samples</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">=&gt;</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#F8F8F2">  </span><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> i </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">  </span><span style="color:#6272A4">// samples 就是那些数据包</span></span>
<span class="line"><span style="color:#F8F8F2">  </span><span style="color:#FF79C6">for</span><span style="color:#F8F8F2"> (; i </span><span style="color:#FF79C6">&lt;</span><span style="color:#F8F8F2"> samples.length; i</span><span style="color:#FF79C6">++</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#F8F8F2">    </span><span style="color:#FF79C6">const</span><span style="color:#F8F8F2"> sample </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> samples[i]</span></span>
<span class="line"><span style="color:#F8F8F2">    </span><span style="color:#FF79C6">const</span><span style="color:#F8F8F2"> timestamp </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> sample.cts </span><span style="color:#FF79C6">/</span><span style="color:#F8F8F2"> sample.timescale </span><span style="color:#6272A4">// 单位是秒</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">    </span><span style="color:#6272A4">// 将数据包转发给 decoder 去解码</span></span>
<span class="line"><span style="color:#F8F8F2">    decoder.</span><span style="color:#50FA7B">decode</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6;font-weight:bold">new</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">EncodedVideoChunk</span><span style="color:#F8F8F2">({</span></span>
<span class="line"><span style="color:#F8F8F2">      type</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> sample.is_sync </span><span style="color:#FF79C6">?</span><span style="color:#F8F8F2"> </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">key</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">delta</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">, </span><span style="color:#6272A4">// 类似关键帧的概念...</span></span>
<span class="line"><span style="color:#F8F8F2">      timestamp</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> timestamp </span><span style="color:#FF79C6">*</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">1e6</span><span style="color:#F8F8F2">, </span><span style="color:#6272A4">// 单位换算</span></span>
<span class="line"><span style="color:#F8F8F2">      duration</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> sample.duration </span><span style="color:#FF79C6">*</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">1e6</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">/</span><span style="color:#F8F8F2"> sample.timescale,</span></span>
<span class="line"><span style="color:#F8F8F2">      data</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> sample.data,</span></span>
<span class="line"><span style="color:#F8F8F2">    }))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">    </span><span style="color:#6272A4">// 等待解码完全结束，也就是所有的画面都解码完成了，然后就可以关闭 decoder 了</span></span>
<span class="line"><span style="color:#F8F8F2">    </span><span style="color:#FF79C6">await</span><span style="color:#F8F8F2"> decoder.</span><span style="color:#50FA7B">flush</span><span style="color:#F8F8F2">();</span></span>
<span class="line"><span style="color:#F8F8F2">    decoder.</span><span style="color:#50FA7B">close</span><span style="color:#F8F8F2">();</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">// 配置 mp4box 自动拆解视频轨道的数据包，然后开始处理文件。</span></span>
<span class="line"><span style="color:#F8F8F2">mp4boxInputFile.</span><span style="color:#50FA7B">setExtractionOptions</span><span style="color:#F8F8F2">(track.id, </span><span style="color:#BD93F9">null</span><span style="color:#F8F8F2">, { nbSamples</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">Infinity</span><span style="color:#F8F8F2"> });</span></span>
<span class="line"><span style="color:#F8F8F2">mp4boxInputFile.</span><span style="color:#50FA7B">start</span><span style="color:#F8F8F2">();</span></span></code></pre>
<p>onSamples 这个回调会在 mp4box.js 拆解完文件后调用。具体数据包的格式可以参考 <a href="https://github.com/gpac/mp4box.js?tab=readme-ov-file#onsamplesid-user-samples">他们的文档</a>。
里面有一个 <code>unused</code> 参数，没啥用，等同于 <code>setExtractionOptions</code> 时候传入的第二个参数，也就是 null。</p>
<h3 id="跳过前后只解码一个时间范围">跳过前后，只解码一个时间范围</h3>
<p>有时候我们只需要某一些时间范围的画面，不需要解码整个文件。此时可以考虑跳过部分 sample。</p>
<p>值得一提的是，虽然 mp4box 文件对象提供了 <code>seek(time, useRap=false)</code> 的方法，但是在我们这个场景下没有用。
它返回的是你需要额外下载的文件数据，从哪里开始。如果你在做按需分块加载视频的功能，那么可能有点用（还记得一开始那个 <code>buffer.fileStart</code> 和 <code>appendBuffer</code> 么？）。然而我们这个场景下，可以读取到 <strong>整个文件</strong>，因此没有追加加载文件数据的情况。</p>
<p>由于我们是整个文件、整个视频轨的解码，因此 <code>onSamples</code> 能够拿到所有视频数据包。所以我们只能在回调里，根据规则跳过一些 samples。</p>
<p>前面代码的循环中，我们读取到了数据包的画面时间戳 <code>timestamp</code>，因此可以在利用 <code>break</code> 语句，跳过结束时间之后的画面解码。</p>
<p>但是，跳过开始时间之前的画面，还额外有一些技巧。以下是我使用的代码：</p>
<pre class="astro-code dracula" style="background-color:#282A36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#6272A4">// start 就是我们要截取的开始时间（秒）</span></span>
<span class="line"><span style="color:#FF79C6">const</span><span style="color:#F8F8F2"> start </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">2.1</span><span style="color:#F8F8F2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">while</span><span style="color:#F8F8F2"> (i </span><span style="color:#FF79C6">&lt;</span><span style="color:#F8F8F2"> samples.length </span><span style="color:#FF79C6">&amp;&amp;</span><span style="color:#F8F8F2"> ((samples[i].cts </span><span style="color:#FF79C6">+</span><span style="color:#F8F8F2"> samples[i].duration) </span><span style="color:#FF79C6">/</span><span style="color:#F8F8F2"> samples[i].timescale </span><span style="color:#FF79C6">&lt;</span><span style="color:#F8F8F2"> start)) i</span><span style="color:#FF79C6">++</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#FF79C6">while</span><span style="color:#F8F8F2"> (i </span><span style="color:#FF79C6">&gt;</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">&amp;&amp;</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">!</span><span style="color:#F8F8F2">samples[i].is_sync) i</span><span style="color:#FF79C6">--</span><span style="color:#F8F8F2">;</span></span></code></pre>
<p>正如我们在播放器里拖动进度条，不一定能完美跳到那个时间点一样。为了压缩数据，一个视频帧画面，可能依赖了前面N帧的画面，因此要解码这一帧，我们得从它依赖的最前面的帧开始解码。</p>
<p>上面代码在找到当前时刻的数据包后，还回溯找到最近的关键帧，作为解码的起点。通过 <code>is_sync</code> 可以确定是否是关键帧，我们从那里开始解码就行了。</p>
<p>但是这就结束了么？</p>
<p>说到这里，还得补充一个细节，就是 <strong>数据包不一定是按照画面呈现先后排列的！</strong> 比如坂本同学反复横跳，对视频压缩算法而言，它可能会倾向于把相似的画面放在一起压缩 —— 只需要播放给你时调整画面顺序就OK了。</p>

<figure><div class="flex"><img src="/_astro/cts-dts.8e7042c9.gif" class="mr-2"/><img src="/_astro/cts-dts.47898160.png" class="min-w-0 flex-1"/></div><figcaption><p>第一行为呈现顺序，第二行为画面解码顺序（相似的画面放一起，压缩率更高）</p></figcaption></figure>
<p>考虑到 mp4box 应该是按照解码顺序来切割的，因此我们用 <code>break</code> 语句提前结束解码，可能导致一些画面的丢失。一个调整方式大概是</p>
<ol>
<li>
<p>在 <code>for</code> 循环之前准备一个标识变量</p>
<pre class="astro-code dracula" style="background-color:#282A36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> waitingForEndKeyFrame </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">false</span><span style="color:#F8F8F2">;</span></span></code></pre>
</li>
<li>
<p>在 <code>decode</code> 方法之后，补充检查这个标志，解码最后一个必须的关键帧之后再退出循环：</p>
<pre class="astro-code dracula" style="background-color:#282A36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#FF79C6">if</span><span style="color:#F8F8F2"> (timestamp </span><span style="color:#FF79C6">&gt;</span><span style="color:#F8F8F2"> end) waitingForEndKeyFrame </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">true</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#FF79C6">if</span><span style="color:#F8F8F2"> (waitingForEndKeyFrame </span><span style="color:#FF79C6">&amp;&amp;</span><span style="color:#F8F8F2"> sample.is_sync) </span><span style="color:#FF79C6">break</span><span style="color:#F8F8F2">;</span></span></code></pre>
</li>
</ol>
<p>更多关于呈现顺序的事情，可以去搜索 PTS（呈现时间）、DTS（解码时间）这些信息，以及 mp4 标准里关于 ctts、dtts 等的定义。
由于 <a href="https://github.com/gpac/mp4box.js/blob/master/src/isofile-sample-processing.js">mp4box 已经有处理过</a>，所以我们可以用 <code>sample.cts / sample.timescale</code> 直接获得时间戳。</p>
<p>幸运的是，W3C 标准已经要求 VideoDecoder 的 output	回调，按照画面帧的呈现顺序依次调用（<a href="https://www.w3.org/TR/webcodecs/#dom-videodecoder-decode">标准文档</a>）。
这帮我们省了很多事情，直接一帧帧地使用就行了。</p>
<blockquote>
<p>（翻译自W3C）VideoDecoder 标准要求输出画面帧地时候，按照呈现顺序输出。因此在对接一些编解码器同时，用户代理（也就是浏览器）还需要额外对数据做排序，以符合呈现顺序。</p>
</blockquote>
<h3 id="解决手机录像画面颠倒的问题">解决手机录像，画面颠倒的问题</h3>
<p>虽然对电脑录屏等场景，视频轨道的 width、height 等同于视频的宽高。但是，在手机录像等场景中，有可能视频的 width 其实对应的是画面高度，而且还上下颠倒了。</p>
<p>在视频轨道信息 <code>track</code> 里，有一个 <code>matrix</code> 字段，它存储的是一个 <a href="https://zh.wikipedia.org/wiki/%E5%8F%98%E6%8D%A2%E7%9F%A9%E9%98%B5">仿射变换的变换矩阵</a>（的前6个参数）。
将解码结果画到画布时，你得根据这个矩阵做个变换，才能看到正确的画面。</p>
<p>在 HTML Canvas Context 中，有一个 <code>setTransform(matrix)</code> 的方法，可以在绘制画面之前调用，从而将原始坐标 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align:-0.566ex" xmlns="http://www.w3.org/2000/svg" width="5.169ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2284.7 1000" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-1-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-1-TEX-I-1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path><path id="MJX-1-TEX-N-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path><path id="MJX-1-TEX-I-1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-1-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><use data-c="28" xlink:href="#MJX-1-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(389,0)"><use data-c="1D465" xlink:href="#MJX-1-TEX-I-1D465"></use></g><g data-mml-node="mo" transform="translate(961,0)"><use data-c="2C" xlink:href="#MJX-1-TEX-N-2C"></use></g><g data-mml-node="mi" transform="translate(1405.7,0)"><use data-c="1D466" xlink:href="#MJX-1-TEX-I-1D466"></use></g><g data-mml-node="mo" transform="translate(1895.7,0)"><use data-c="29" xlink:href="#MJX-1-TEX-N-29"></use></g></g></g></svg></mjx-container> 变换到正确的坐标 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align:-0.566ex" xmlns="http://www.w3.org/2000/svg" width="6.424ex" height="2.283ex" role="img" focusable="false" viewBox="0 -759 2839.6 1009" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-2-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-2-TEX-I-1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path><path id="MJX-2-TEX-V-2032" d="M79 43Q73 43 52 49T30 61Q30 68 85 293T146 528Q161 560 198 560Q218 560 240 545T262 501Q262 496 260 486Q259 479 173 263T84 45T79 43Z"></path><path id="MJX-2-TEX-N-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path><path id="MJX-2-TEX-I-1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-2-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><use data-c="28" xlink:href="#MJX-2-TEX-N-28"></use></g><g data-mml-node="msup" transform="translate(389,0)"><g data-mml-node="mi"><use data-c="1D465" xlink:href="#MJX-2-TEX-I-1D465"></use></g><g data-mml-node="mo" transform="translate(605,363) scale(0.707)"><use data-c="2032" xlink:href="#MJX-2-TEX-V-2032"></use></g></g><g data-mml-node="mo" transform="translate(1238.5,0)"><use data-c="2C" xlink:href="#MJX-2-TEX-N-2C"></use></g><g data-mml-node="msup" transform="translate(1683.1,0)"><g data-mml-node="mi"><use data-c="1D466" xlink:href="#MJX-2-TEX-I-1D466"></use></g><g data-mml-node="mo" transform="translate(523,363) scale(0.707)"><use data-c="2032" xlink:href="#MJX-2-TEX-V-2032"></use></g></g><g data-mml-node="mo" transform="translate(2450.6,0)"><use data-c="29" xlink:href="#MJX-2-TEX-N-29"></use></g></g></g></svg></mjx-container> 上绘制。</p>
<p><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align:-3.753ex" xmlns="http://www.w3.org/2000/svg" width="23.807ex" height="8.638ex" role="img" focusable="false" viewBox="0 -2159 10522.7 3818" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-3-TEX-S4-23A1" d="M319 -645V1154H666V1070H403V-645H319Z"></path><path id="MJX-3-TEX-S4-23A3" d="M319 -644V1155H403V-560H666V-644H319Z"></path><path id="MJX-3-TEX-S4-23A2" d="M319 0V602H403V0H319Z"></path><path id="MJX-3-TEX-I-1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path><path id="MJX-3-TEX-V-2032" d="M79 43Q73 43 52 49T30 61Q30 68 85 293T146 528Q161 560 198 560Q218 560 240 545T262 501Q262 496 260 486Q259 479 173 263T84 45T79 43Z"></path><path id="MJX-3-TEX-I-1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-3-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-3-TEX-S4-23A4" d="M0 1070V1154H347V-645H263V1070H0Z"></path><path id="MJX-3-TEX-S4-23A6" d="M263 -560V1155H347V-644H0V-560H263Z"></path><path id="MJX-3-TEX-S4-23A5" d="M263 0V602H347V0H263Z"></path><path id="MJX-3-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-3-TEX-I-1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path><path id="MJX-3-TEX-I-1D450" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path><path id="MJX-3-TEX-I-1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path><path id="MJX-3-TEX-I-1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path><path id="MJX-3-TEX-I-1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path><path id="MJX-3-TEX-I-1D453" d="M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z"></path><path id="MJX-3-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mrow"><g data-mml-node="mo"><use data-c="23A1" xlink:href="#MJX-3-TEX-S4-23A1" transform="translate(0,1005)"></use><use data-c="23A3" xlink:href="#MJX-3-TEX-S4-23A3" transform="translate(0,-1015)"></use><svg width="667" height="420" y="40" x="0" viewBox="0 105 667 420"><use data-c="23A2" xlink:href="#MJX-3-TEX-S4-23A2" transform="scale(1,1.046)"></use></svg></g><g data-mml-node="mtable" transform="translate(667,0)"><g data-mml-node="mtr" transform="translate(0,1400)"><g data-mml-node="mtd"><g data-mml-node="msup"><g data-mml-node="mi"><use data-c="1D465" xlink:href="#MJX-3-TEX-I-1D465"></use></g><g data-mml-node="mo" transform="translate(605,363) scale(0.707)"><use data-c="2032" xlink:href="#MJX-3-TEX-V-2032"></use></g></g></g></g><g data-mml-node="mtr" transform="translate(0,-9)"><g data-mml-node="mtd" transform="translate(41,0)"><g data-mml-node="msup"><g data-mml-node="mi"><use data-c="1D466" xlink:href="#MJX-3-TEX-I-1D466"></use></g><g data-mml-node="mo" transform="translate(523,363) scale(0.707)"><use data-c="2032" xlink:href="#MJX-3-TEX-V-2032"></use></g></g></g></g><g data-mml-node="mtr" transform="translate(0,-1409)"><g data-mml-node="mtd" transform="translate(174.7,0)"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-3-TEX-N-31"></use></g></g></g></g><g data-mml-node="mo" transform="translate(1516.5,0)"><use data-c="23A4" xlink:href="#MJX-3-TEX-S4-23A4" transform="translate(0,1005)"></use><use data-c="23A6" xlink:href="#MJX-3-TEX-S4-23A6" transform="translate(0,-1015)"></use><svg width="667" height="420" y="40" x="0" viewBox="0 105 667 420"><use data-c="23A5" xlink:href="#MJX-3-TEX-S4-23A5" transform="scale(1,1.046)"></use></svg></g></g><g data-mml-node="mo" transform="translate(2461.2,0)"><use data-c="3D" xlink:href="#MJX-3-TEX-N-3D"></use></g><g data-mml-node="mrow" transform="translate(3517,0)"><g data-mml-node="mo"><use data-c="23A1" xlink:href="#MJX-3-TEX-S4-23A1" transform="translate(0,996)"></use><use data-c="23A3" xlink:href="#MJX-3-TEX-S4-23A3" transform="translate(0,-1006)"></use><svg width="667" height="402" y="49" x="0" viewBox="0 100.5 667 402"><use data-c="23A2" xlink:href="#MJX-3-TEX-S4-23A2" transform="scale(1,1.002)"></use></svg></g><g data-mml-node="mtable" transform="translate(667,0)"><g data-mml-node="mtr" transform="translate(0,1400)"><g data-mml-node="mtd"><g data-mml-node="mi"><use data-c="1D44E" xlink:href="#MJX-3-TEX-I-1D44E"></use></g></g><g data-mml-node="mtd" transform="translate(1572.5,0)"><g data-mml-node="mi"><use data-c="1D450" xlink:href="#MJX-3-TEX-I-1D450"></use></g></g><g data-mml-node="mtd" transform="translate(3091,0)"><g data-mml-node="mi"><use data-c="1D452" xlink:href="#MJX-3-TEX-I-1D452"></use></g></g></g><g data-mml-node="mtr"><g data-mml-node="mtd" transform="translate(50,0)"><g data-mml-node="mi"><use data-c="1D44F" xlink:href="#MJX-3-TEX-I-1D44F"></use></g></g><g data-mml-node="mtd" transform="translate(1529,0)"><g data-mml-node="mi"><use data-c="1D451" xlink:href="#MJX-3-TEX-I-1D451"></use></g></g><g data-mml-node="mtd" transform="translate(3049,0)"><g data-mml-node="mi"><use data-c="1D453" xlink:href="#MJX-3-TEX-I-1D453"></use></g></g></g><g data-mml-node="mtr" transform="translate(0,-1400)"><g data-mml-node="mtd" transform="translate(14.5,0)"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-3-TEX-N-30"></use></g></g><g data-mml-node="mtd" transform="translate(1539,0)"><g data-mml-node="mn"><use data-c="30" xlink:href="#MJX-3-TEX-N-30"></use></g></g><g data-mml-node="mtd" transform="translate(3074,0)"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-3-TEX-N-31"></use></g></g></g></g><g data-mml-node="mo" transform="translate(4266,0)"><use data-c="23A4" xlink:href="#MJX-3-TEX-S4-23A4" transform="translate(0,996)"></use><use data-c="23A6" xlink:href="#MJX-3-TEX-S4-23A6" transform="translate(0,-1006)"></use><svg width="667" height="402" y="49" x="0" viewBox="0 100.5 667 402"><use data-c="23A5" xlink:href="#MJX-3-TEX-S4-23A5" transform="scale(1,1.002)"></use></svg></g></g><g data-mml-node="mrow" transform="translate(8616.7,0)"><g data-mml-node="mo"><use data-c="23A1" xlink:href="#MJX-3-TEX-S4-23A1" transform="translate(0,996)"></use><use data-c="23A3" xlink:href="#MJX-3-TEX-S4-23A3" transform="translate(0,-1006)"></use><svg width="667" height="402" y="49" x="0" viewBox="0 100.5 667 402"><use data-c="23A2" xlink:href="#MJX-3-TEX-S4-23A2" transform="scale(1,1.002)"></use></svg></g><g data-mml-node="mtable" transform="translate(667,0)"><g data-mml-node="mtr" transform="translate(0,1400)"><g data-mml-node="mtd"><g data-mml-node="mi"><use data-c="1D465" xlink:href="#MJX-3-TEX-I-1D465"></use></g></g></g><g data-mml-node="mtr"><g data-mml-node="mtd" transform="translate(41,0)"><g data-mml-node="mi"><use data-c="1D466" xlink:href="#MJX-3-TEX-I-1D466"></use></g></g></g><g data-mml-node="mtr" transform="translate(0,-1400)"><g data-mml-node="mtd" transform="translate(36,0)"><g data-mml-node="mn"><use data-c="31" xlink:href="#MJX-3-TEX-N-31"></use></g></g></g></g><g data-mml-node="mo" transform="translate(1239,0)"><use data-c="23A4" xlink:href="#MJX-3-TEX-S4-23A4" transform="translate(0,996)"></use><use data-c="23A6" xlink:href="#MJX-3-TEX-S4-23A6" transform="translate(0,-1006)"></use><svg width="667" height="402" y="49" x="0" viewBox="0 100.5 667 402"><use data-c="23A5" xlink:href="#MJX-3-TEX-S4-23A5" transform="scale(1,1.002)"></use></svg></g></g></g></g></svg></mjx-container></p>
<p>然而 <code>track.matrix</code> 存储的是32位定点数（也就是要除以65536才是真实的值），而且其存储顺序和 HTML Canvas 的矩阵参数顺序不一样。它存储的顺序是 <code>[a, c, e, b, d, f]</code>。</p>
<p>因此回到最开始解析 <code>description</code> 的地方，我们像这样可以计算 <strong>Canvas 绘图时使用的</strong> 变换矩阵：</p>
<pre class="astro-code dracula" style="background-color:#282A36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> transform</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> </span><span style="color:#8BE9FD;font-style:italic">DOMMatrix</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">const</span><span style="color:#F8F8F2"> [a, c, e, b, d, f] </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> Array.</span><span style="color:#50FA7B">from</span><span style="color:#F8F8F2">(track.matrix.</span><span style="color:#50FA7B">slice</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">6</span><span style="color:#F8F8F2">), (</span><span style="color:#FFB86C;font-style:italic">x</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> </span><span style="color:#8BE9FD;font-style:italic">number</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">=&gt;</span><span style="color:#F8F8F2"> x </span><span style="color:#FF79C6">/</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">65536</span><span style="color:#F8F8F2">) </span><span style="color:#6272A4">// Fixed-float number</span></span>
<span class="line"><span style="color:#FF79C6">const</span><span style="color:#F8F8F2"> matrix </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6;font-weight:bold">new</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">DOMMatrix</span><span style="color:#F8F8F2">([a, b, c, d, e, f])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">// 使用矩阵乘法，计算真正呈现的画面宽高（不太严谨，但是够用）</span></span>
<span class="line"><span style="color:#FF79C6">const</span><span style="color:#F8F8F2"> videoWidth </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> Math.</span><span style="color:#50FA7B">abs</span><span style="color:#F8F8F2">(a </span><span style="color:#FF79C6">*</span><span style="color:#F8F8F2"> track.track_width </span><span style="color:#FF79C6">+</span><span style="color:#F8F8F2"> c </span><span style="color:#FF79C6">*</span><span style="color:#F8F8F2"> track.track_height)</span></span>
<span class="line"><span style="color:#FF79C6">const</span><span style="color:#F8F8F2"> videoHeight </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> Math.</span><span style="color:#50FA7B">abs</span><span style="color:#F8F8F2">(b </span><span style="color:#FF79C6">*</span><span style="color:#F8F8F2"> track.track_width </span><span style="color:#FF79C6">+</span><span style="color:#F8F8F2"> d </span><span style="color:#FF79C6">*</span><span style="color:#F8F8F2"> track.track_height)</span></span>
<span class="line"><span style="color:#6272A4">// 备注：你可以看情况用到 canvas 上</span></span>
<span class="line"><span style="color:#6272A4">// canvas.width = videoWidth</span></span>
<span class="line"><span style="color:#6272A4">// canvas.height = videoHeight</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">// 为 Canvas 计算变换矩阵</span></span>
<span class="line"><span style="color:#6272A4">// 注意：这里变换过程要倒着读，详情参考矩阵的乘法的顺序</span></span>
<span class="line"><span style="color:#F8F8F2">transform </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6;font-weight:bold">new</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">DOMMatrix</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#F8F8F2">  .</span><span style="color:#50FA7B">translate</span><span style="color:#F8F8F2">(resizeWidth </span><span style="color:#FF79C6">/</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">2</span><span style="color:#F8F8F2">, resizeHeight </span><span style="color:#FF79C6">/</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">2</span><span style="color:#F8F8F2">)                   </span><span style="color:#6272A4">// 4. 从原点移动回去整个画布上</span></span>
<span class="line"><span style="color:#F8F8F2">  .</span><span style="color:#50FA7B">scale</span><span style="color:#F8F8F2">(canvas.width </span><span style="color:#FF79C6">/</span><span style="color:#F8F8F2"> videoWidth, canvas.height </span><span style="color:#FF79C6">/</span><span style="color:#F8F8F2"> videoHeight)  </span><span style="color:#6272A4">// 3. 此时画面已经摆正，按照 canvas 的需要缩放画面</span></span>
<span class="line"><span style="color:#F8F8F2">  .</span><span style="color:#50FA7B">multiply</span><span style="color:#F8F8F2">(matrix.</span><span style="color:#50FA7B">inverse</span><span style="color:#F8F8F2">())                                     </span><span style="color:#6272A4">// 2. 按照 matrix 旋转画面（求逆的必要性懒得查标准了）</span></span>
<span class="line"><span style="color:#F8F8F2">  .</span><span style="color:#50FA7B">translate</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">-</span><span style="color:#F8F8F2">track.track_width </span><span style="color:#FF79C6">/</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">2</span><span style="color:#F8F8F2">, </span><span style="color:#FF79C6">-</span><span style="color:#F8F8F2">track.track_height </span><span style="color:#FF79C6">/</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">2</span><span style="color:#F8F8F2">)     </span><span style="color:#6272A4">// 1. 将画面平移到原点中央</span></span></code></pre>
<p>以及在绘制画面帧的时候，像这样处理：</p>
<pre class="astro-code dracula" style="background-color:#282A36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#F8F8F2">ctx.</span><span style="color:#50FA7B">resetTransform</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#F8F8F2">ctx.</span><span style="color:#50FA7B">clearRect</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">, canvas.width, canvas.height)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">ctx.</span><span style="color:#50FA7B">setTransform</span><span style="color:#F8F8F2">(transform)</span></span>
<span class="line"><span style="color:#F8F8F2">ctx.</span><span style="color:#50FA7B">drawImage</span><span style="color:#F8F8F2">(inputFrame, </span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">)</span></span></code></pre>
<p>这样子，就可以解决手机拍摄的视频可能发生旋转的问题了。</p>
<p>我猜测可能是手机为了减少画面数据处理的繁琐性，选择了直接将传感器的数据送给视频编码器，然后再通过 MP4 的 matrix 让播放器负责变换画面。
只能说 mp4 是一个神奇的格式。前面提到的 ctts 之类的东西，还能用于手机的慢动作视频变速播放（很多手机调整变速范围时，不需要重新编码，就是靠 mp4 的这些神奇功能实现的）。
虽然很灵活，但也苦了播放器的开发者了。</p>
<h2 id="最后">最后</h2>
<p>说到这里，复杂的工作就算是结束了。有了 WebCodec 极速解码画面，结合一开始祖传的 ffmpeg 指令，就能快速转换视频为高质量 GIF 了。具体的说，就是将画面原始 RGBA 二进制数据导入到 ffmpeg，让它用特定参数去识别，就可以用了：</p>
<pre class="astro-code dracula" style="background-color:#282A36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0"><code><span class="line"><span style="color:#50FA7B">ffmpeg</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">\</span></span>
<span class="line"><span style="color:#F8F8F2">	</span><span style="color:#BD93F9">-f</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">rawvideo</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">-pix_fmt</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">rgba</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">\</span></span>
<span class="line"><span style="color:#F8F8F2">	</span><span style="color:#BD93F9">-video_size</span><span style="color:#F8F8F2"> ${</span><span style="color:#BD93F9">canvas</span><span style="color:#F8F8F2">.</span><span style="color:#BD93F9">width</span><span style="color:#F8F8F2">}</span><span style="color:#F1FA8C">x</span><span style="color:#F8F8F2">${</span><span style="color:#BD93F9">canvas</span><span style="color:#F8F8F2">.</span><span style="color:#BD93F9">height</span><span style="color:#F8F8F2">} </span><span style="color:#FF79C6">\</span></span>
<span class="line"><span style="color:#F8F8F2">	</span><span style="color:#BD93F9">-framerate</span><span style="color:#F8F8F2"> ${自己看着办} </span><span style="color:#FF79C6">\</span></span>
<span class="line"><span style="color:#F8F8F2">	</span><span style="color:#BD93F9">-i</span><span style="color:#F8F8F2"> </span><span style="color:#F1FA8C">temp.bin</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">\</span></span>
<span class="line"><span style="color:#F8F8F2">	</span><span style="color:#6272A4"># 。。。此处加祖传参数</span></span></code></pre>
<p>实测发现 wasm 做 GIF 的调色板生成、编码压缩，速度是比 JavaScript 的库更快的。而且还能用 ffmpeg 的各种神秘小参数。</p>
<br/>
<p>以防万一没看到前面链接，这里再贴一次：</p>
<ul>
<li>在线体验： <a href="https://lyonbot.github.io/video-to-gif/">https://lyonbot.github.io/video-to-gif/</a></li>
<li>代码（欢迎 Star）： <a href="https://github.com/lyonbot/video-to-gif">https://github.com/lyonbot/video-to-gif</a></li>
</ul>
<video src="/_astro/video-to-gif.84391a6c.mp4" loop="-1" muted="true" autoplay class="max-w-full mx-auto block"></video>
<h3 id="最最后碎碎念一段-signal">最最后，碎碎念一段 Signal</h3>
<p>这次使用的是 SolidJS、UnoCSS、Vite 的方案，开发体验还是很不错的。</p>
<p>曾经还想写一篇文章聊聊 SolidJS Signal 的概念多牛皮，但是正逢上 Vue 党狂吹 Signal 的那段时间，外加自己比较懒（重点），所以就鸽了。</p>
<p>我感觉Signal的重点，不是响应式、Proxy之类实现方式的问题（s.js 和 SolidJS 通过 Accessor 函数来读写变量虽然丑，但也不是致命点），而是「计算作用域」的概念。
基于「计算可以嵌套」的特性，把一个UI组件/类实例…视为一个域，然后里面的属性/子元素，又划分为更细粒度的子域，从而实现真·超细粒度响应式更新。</p>
<p>配合趁手的写法（无论是 Vue 的模版语言编译器，还是 <a href="https://www.npmjs.com/package/babel-plugin-jsx-dom-expressions">SolidJS 魔改的 JSX</a>，还是 createEffect 嵌套 createEffect 的写法……都可以），
让子计算的创建足够简单容易，就能体会到 Signal 这种范式有多么潇洒。</p>
<p>也许很适合低代码？（emmm，虽然我们团队的低代码项目走向已逐渐离谱，想那么多已经没落地的机会了）（又是一个之前想写但是鸽了的东西）</p>
<p>再说吧，咱最近主打的就是一个 P人属性大爆发。</p><style>
mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
  min-height: 1px;
  min-width: 1px;
}

mjx-container[jax="SVG"] > svg a {
  fill: blue;
  stroke: blue;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][display="true"][width="full"] {
  display: flex;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line], svg[data-table] > g > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame], svg[data-table] > g > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed, svg[data-table] > g > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted, svg[data-table] > g > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > g > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

mjx-container[jax="SVG"] path[data-c], mjx-container[jax="SVG"] use[data-c] {
  stroke-width: 3;
}
</style></div></article></div><button id="to-top-btn" class="z-90 fixed bottom-8 end-4 flex h-10 w-10 translate-y-28 items-center justify-center rounded-full border-2 border-transparent bg-zinc-200 text-3xl opacity-0 transition-all duration-300 hover:border-zinc-400 data-[show=true]:translate-y-0 data-[show=true]:opacity-100 dark:bg-zinc-700 sm:end-8 sm:h-12 sm:w-12" aria-label="Back to Top" data-show="false"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="h-6 w-6"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5"></path></svg></button></main><footer class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top text-gray-500 sm:flex-row sm:justify-between sm:text-xs"><div class="me-0 sm:me-4">
Copyright &copy; 2024<span class="mx-2" aria-hidden="true">🦾</span>lyonbot</div><nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500"><a href="/" class="px-4 py-2 sm:px-2 sm:py-0 sm:hover:text-textColor sm:hover:underline">Home</a><a href="/about/" class="px-4 py-2 sm:px-2 sm:py-0 sm:hover:text-textColor sm:hover:underline">About</a><a href="/post/" class="px-4 py-2 sm:px-2 sm:py-0 sm:hover:text-textColor sm:hover:underline">Blog</a></nav></footer></body></html>